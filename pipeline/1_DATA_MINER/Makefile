# Data Miner Makefile
# Document Structuring Engine - PDF to ML-ready data pipeline

# Project configuration
PROJECT_NAME := data-miner
BINARY_NAME := data-miner
MAIN_PACKAGE := ./cmd/$(PROJECT_NAME)
BIN_DIR := bin
BUILD_DIR := build
DIST_DIR := dist

# Go configuration
GO_FILES := $(shell find . -name '*.go' -type f)
GO_VERSION := $(shell go version | awk '{print $$3}')
GOOS := $(shell go env GOOS)
GOARCH := $(shell go env GOARCH)

# Build flags
SPACY_LIB_DIR := $(CURDIR)/spacy/lib
LDFLAGS := -ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME) -X main.gitCommit=$(GIT_COMMIT) -extldflags '-Wl,-rpath,$(SPACY_LIB_DIR)'"
BUILD_FLAGS := -trimpath -buildmode=pie $(LDFLAGS)

# Version information
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
GIT_COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Default target
.PHONY: all
all: clean deps build

# Help target
.PHONY: help
help:
	@echo "Data Miner - Document Structuring Engine"
	@echo "=========================================="
	@echo ""
	@echo "Available targets:"
	@echo "  all          Clean, deps, and build"
	@echo "  build        Build the binary"
	@echo "  build-all    Build for all platforms"
	@echo "  clean        Clean build artifacts"
	@echo "  deps         Download dependencies"
	@echo "  test         Run tests"
	@echo "  test-cover   Run tests with coverage"
	@echo "  lint         Run linter"
	@echo "  fmt          Format code"
	@echo "  vet          Run go vet"
	@echo "  install      Install binary to system"
	@echo "  uninstall    Remove binary from system"
	@echo "  run          Run with default configuration"
	@echo "  run-prod     Run in production mode (GOAT dataset default)"
	@echo "  run-test     Run in test mode"
	@echo "  run-opt      Run in optimized mode"
	@echo "  run-hybrid   Run in hybrid mode"
	@echo "  run-goat     Run specifically for GOAT dataset retrieval"
	@echo "  run-arxiv    Run specifically for arXiv mining"
	@echo "  run-workflow Run integrated workflow"
	@echo "  dev          Development build and run"
	@echo "  debug        Debug mode with dry-run"
	@echo "  monitor     Production mode with monitoring"
	@echo "  status       Show project status"
	@echo "  kill-servers Kill all opencode and ollama processes"
	@echo "  release      Create release build"
	@echo "  docker       Build Docker image"
	@echo "  docs         Generate documentation"
	@echo ""
	@echo "Application Commands:"
	@echo "  run-workflow    Run production workflow"
	@echo "  test-workflow   Run test workflow"
	@echo "  run-optimized   Run with optimizations"
	@echo "  run-hybrid      Run with hybrid embeddings"
	@echo "  build           Build the project"
	@echo "  deps            Check dependencies"
	@echo "  clean           Clean build artifacts"
	@echo "  help            Show application help"
	@echo "  list-modes      List available modes"
	@echo ""
	@echo "Execution Modes:"
	@echo "  production      Production workflow mode"
	@echo "  test            Test mode with limited scope"
	@echo "  optimized       CPU/GPU optimized mode"
	@echo "  hybrid          Hybrid embeddings mode"
	@echo "  neural          Neural processing only"
	@echo "  arxiv           ArXiv mining only"
	@echo "  workflow        Integrated workflow"
	@echo ""
	@echo "Examples:"
	@echo "  make run                    # Run with default config"
	@echo "  make run-prod               # Production mode"
	@echo "  make run-test INPUT=./test  # Test mode with custom input"
	@echo "  make build-all              # Build for all platforms"

# Dependencies
.PHONY: deps
deps:
	@echo "ðŸ“¦ Downloading dependencies..."
	go mod download
	go mod tidy
	@echo "âœ… Dependencies updated"

# Build targets
.PHONY: build
build: spacy-lib
	@echo "ðŸ”¨ Building $(BINARY_NAME)..."
	@mkdir -p $(BIN_DIR)
	go build $(BUILD_FLAGS) -o $(BIN_DIR)/$(BINARY_NAME) $(MAIN_PACKAGE)
	@echo "âœ… Build completed: $(BIN_DIR)/$(BINARY_NAME)"

# Build for all platforms
.PHONY: build-all
build-all:
	@echo "ðŸ”¨ Building for all platforms..."
	@mkdir -p $(DIST_DIR)
	
	# Linux AMD64
	GOOS=linux GOARCH=amd64 go build $(BUILD_FLAGS) -o $(DIST_DIR)/$(BINARY_NAME)-linux-amd64 $(MAIN_PACKAGE)
	
	# Linux ARM64
	GOOS=linux GOARCH=arm64 go build $(BUILD_FLAGS) -o $(DIST_DIR)/$(BINARY_NAME)-linux-arm64 $(MAIN_PACKAGE)
	
	# macOS AMD64
	GOOS=darwin GOARCH=amd64 go build $(BUILD_FLAGS) -o $(DIST_DIR)/$(BINARY_NAME)-darwin-amd64 $(MAIN_PACKAGE)
	
	# macOS ARM64
	GOOS=darwin GOARCH=arm64 go build $(BUILD_FLAGS) -o $(DIST_DIR)/$(BINARY_NAME)-darwin-arm64 $(MAIN_PACKAGE)
	
	# Windows AMD64
	GOOS=windows GOARCH=amd64 go build $(BUILD_FLAGS) -o $(DIST_DIR)/$(BINARY_NAME)-windows-amd64.exe $(MAIN_PACKAGE)
	
	@echo "âœ… Multi-platform build completed in $(DIST_DIR)/"

# Development build
.PHONY: dev
dev: build
	@echo "ðŸš€ Running in development mode..."
	$(BIN_DIR)/$(BINARY_NAME) -test -dry-run

# Clean targets
.PHONY: clean
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@rm -rf $(BIN_DIR)
	@rm -rf $(BUILD_DIR)
	@rm -rf $(DIST_DIR)
	@rm -f $(BINARY_NAME)
	@rm -f /tmp/ollama_*.log
	@echo "âœ… Clean completed"

# Test targets
.PHONY: test
test:
	@echo "ðŸ§ª Running tests..."
	go test -v ./...

.PHONY: test-cover
test-cover:
	@echo "ðŸ§ª Running tests with coverage..."
	go test -v -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "ðŸ“Š Coverage report: coverage.html"

# Code quality targets
.PHONY: fmt
fmt:
	@echo "ðŸŽ¨ Formatting code..."
	go fmt ./...

.PHONY: vet
vet:
	@echo "ðŸ” Running go vet..."
	go vet ./...

.PHONY: lint
lint:
	@echo "ðŸ” Running linter..."
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
	else \
		echo "âš ï¸  golangci-lint not found, installing..."; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
		golangci-lint run; \
	fi


# Build the spacy C++ library
.PHONY: spacy-lib
spacy-lib:
	@echo "Building spacy C++ library..."
	cd spacy && go run build.go
	
# Installation targets
.PHONY: install
install: build
	@echo "ðŸ“¦ Installing $(BINARY_NAME) to /usr/local/bin..."
	sudo cp $(BIN_DIR)/$(BINARY_NAME) /usr/local/bin/
	@echo "âœ… Installation completed"

.PHONY: uninstall
uninstall:
	@echo "ðŸ—‘ï¸  Removing $(BINARY_NAME) from system..."
	sudo rm -f /usr/local/bin/$(BINARY_NAME)
	@echo "âœ… Uninstallation completed"

# Application run targets
.PHONY: run
run: build
	@echo "ðŸš€ Running Data Miner with default configuration..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) run

.PHONY: run-prod
run-prod: build
	@echo "ðŸš€ Running Data Miner in production mode..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) production

.PHONY: run-test
run-test: build
	@echo "ðŸ§ª Running Data Miner in test mode..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) test

.PHONY: run-opt
run-opt: build
	@echo "âš¡ Running Data Miner in optimized mode..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) optimized

.PHONY: run-hybrid
run-hybrid: build
	@echo "ðŸ”„ Running Data Miner in hybrid mode..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) hybrid

.PHONY: run-goat
run-goat: build
	@echo "ðŸ Running Data Miner with GOAT dataset..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) -goat

.PHONY: run-arxiv
run-arxiv: build
	@echo "ðŸ“š Running Data Miner with arXiv mining..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) -arxiv-enable

.PHONY: run-workflow
run-workflow: build
	@echo "ðŸ”„ Running Data Miner in workflow mode (arXiv + neural)..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) -arxiv-enable -production

.PHONY: run-arxiv-only
run-arxiv-only: build
	@echo "ðŸ“š Running Data Miner in arXiv-only mode..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) -arxiv-enable

# Application command targets (using script commands)
.PHONY: app-run-workflow
app-run-workflow: build
	@echo "ðŸ­ Running production workflow command..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) run-workflow

.PHONY: app-test-workflow
app-test-workflow: build
	@echo "ðŸ§ª Running test workflow command..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) test-workflow

.PHONY: app-run-optimized
app-run-optimized: build
	@echo "âš¡ Running optimized workflow command..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) run-optimized

.PHONY: app-run-hybrid
app-run-hybrid: build
	@echo "ðŸ”„ Running hybrid workflow command..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) run-hybrid

.PHONY: app-help
app-help: build
	@echo "ðŸ“– Showing application help..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) help

.PHONY: list-modes
list-modes: build
	@echo "ðŸ“‹ Listing available modes..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) list-modes

.PHONY: check-deps
check-deps: build
	@echo "ðŸ” Checking dependencies..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) deps

.PHONY: app-clean
app-clean: build
	@echo "ðŸ§¹ Cleaning application artifacts..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) clean

# Custom run with parameters
.PHONY: run-custom
run-custom: build
	@if [ -z "$(INPUT)" ]; then \
		echo "âŒ INPUT parameter required"; \
		echo "Usage: make run-custom INPUT=/path/to/pdfs [OUTPUT=/path/to/output.json]"; \
		exit 1; \
	fi
	@echo "ðŸš€ Running Data Miner with custom configuration..."
	LD_LIBRARY_PATH=$(SPACY_LIB_DIR) $(BIN_DIR)/$(BINARY_NAME) -input "$(INPUT)" -output "$(OUTPUT)"

# Release build
.PHONY: release
release: clean fmt vet lint test build-all
	@echo "ðŸ“¦ Creating release package..."
	@mkdir -p $(DIST_DIR)/release
	@cp -r $(DIST_DIR)/* $(DIST_DIR)/release/
	@echo "âœ… Release package created in $(DIST_DIR)/release/"

# Docker targets
.PHONY: docker
docker:
	@echo "ðŸ³ Building Docker image..."
	docker build -t $(PROJECT_NAME):$(VERSION) .
	docker tag $(PROJECT_NAME):$(VERSION) $(PROJECT_NAME):latest
	@echo "âœ… Docker image built: $(PROJECT_NAME):$(VERSION)"

.PHONY: docker-run
docker-run:
	@echo "ðŸ³ Running Docker container..."
	docker run --rm -it \
		-v $(PWD)/data:/app/data \
		$(PROJECT_NAME):latest

# Documentation
.PHONY: docs
docs:
	@echo "ðŸ“š Generating documentation..."
	@if command -v godoc >/dev/null 2>&1; then \
		echo "ðŸŒ Documentation available at: http://localhost:6060/pkg/"; \
		godoc -http=:6060 & \
		sleep 2 && \
		echo "ðŸ“– Opening documentation in browser..." && \
		xdg-open http://localhost:6060/pkg/ 2>/dev/null || \
		open http://localhost:6060/pkg/ 2>/dev/null || \
		echo "ðŸŒ Visit http://localhost:6060/pkg/ to view documentation"; \
	else \
		echo "âš ï¸  godoc not found, installing..."; \
		go install golang.org/x/tools/cmd/godoc@latest; \
		$(MAKE) docs; \
	fi

# Development utilities
.PHONY: watch
watch:
	@echo "ðŸ‘€ Watching for changes and rebuilding..."
	@if command -v entr >/dev/null 2>&1; then \
		find . -name '*.go' | entr -r $(MAKE) build; \
	else \
		echo "âš ï¸  entr not found, install with: brew install entr or apt-get install entr"; \
	fi

.PHONY: benchmark
benchmark:
	@echo "â±ï¸  Running benchmarks..."
	go test -bench=. -benchmem ./...

# Security
.PHONY: security
security:
	@echo "ðŸ”’ Running security checks..."
	@if command -v gosec >/dev/null 2>&1; then \
		gosec ./...; \
	else \
		echo "âš ï¸  gosec not found, installing..."; \
		go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest; \
		gosec ./...; \
	fi

# Project information
.PHONY: info
info:
	@echo "ðŸ“Š Project Information:"
	@echo "  Name: $(PROJECT_NAME)"
	@echo "  Version: $(VERSION)"
	@echo "  Go Version: $(GO_VERSION)"
	@echo "  OS/Arch: $(GOOS)/$(GOARCH)"
	@echo "  Build Time: $(BUILD_TIME)"
	@echo "  Git Commit: $(GIT_COMMIT)"
	@echo "  Binary: $(BIN_DIR)/$(BINARY_NAME)"

# Debug and monitoring targets
.PHONY: debug
debug: build
	@echo "ðŸ› Running Data Miner in debug mode..."
	$(BIN_DIR)/$(BINARY_NAME) -test -dry-run

.PHONY: monitor
monitor: build
	@echo "ðŸ“Š Running Data Miner with monitoring..."
	$(BIN_DIR)/$(BINARY_NAME) -production -arxiv-enable

.PHONY: status
status:
	@echo "ðŸ“Š Project Status:"
	@echo "================="
	@if [ -f $(BIN_DIR)/$(BINARY_NAME) ]; then \
		echo "âœ… Binary: $(BIN_DIR)/$(BINARY_NAME)"; \
		echo "ðŸ“… Build: $(shell date -r $(BIN_DIR)/$(BINARY_NAME) '+%Y-%m-%d %H:%M:%S')"; \
	else \
		echo "âŒ Binary not found - run 'make build'"; \
	fi
	@if [ -d data ]; then \
		echo "ðŸ“ Data directory: data/"; \
		echo "ðŸ“„ PDFs: $$(find data -name '*.pdf' 2>/dev/null | wc -l)"; \
		echo "ðŸ“„ JSON files: $$(find data -name '*.json' 2>/dev/null | wc -l)"; \
	fi

.PHONY: kill-servers
kill-servers:
	@echo "ðŸ›‘ Killing background servers..."
	./scripts/kill_servers.sh

# Quick development shortcuts
.PHONY: q
q: build run

.PHONY: qc
qc: clean build run

.PHONY: qt
qt: clean build test

# Prevent make from deleting intermediate files
.PRECIOUS: $(GO_FILES)

# Default shell
SHELL := /bin/bash

# Enable secondary expansion for advanced patterns
.SECONDEXPANSION: